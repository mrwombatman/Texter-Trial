var browser_polyfill;"undefined"!=typeof browser?browser_polyfill=browser:"undefined"!=typeof chrome&&(browser_polyfill=chrome);const oneHour=3600,tenSeconds=10;let store={};function getCurrentTimestamp(){return Math.floor(Date.now()/1e3)}store.getPendingBatch=async function(){var a=await browser_polyfill.storage.local.get("batchIndex");if(a&&a.batchIndex){var s=getCurrentTimestamp(),r=a.batchIndex;let t,e;for(const u in r){var o=r[u].timestamp,n=s>=o-tenSeconds,i=s<o+oneHour,c="pending"===r[u].status,l=t&&e<o;if(n&&i&&c&&!l&&(t=u,e=o),o+oneHour<s&&"pending"===r[u].status&&(r[u].status="missed",r[u].statusUpdatedTimestamp=s,await browser_polyfill.storage.local.set({batchIndex:r})),"sending"===r[u].status){n=await this.checkBatchForPending(u),i=await this.checkBatchForErrors(u);if(i&&!n)await this.updateBatchStatus(u,"error");else{if(i||n){t=u;break}await this.updateBatchStatus(u,"complete")}}}return t?{batchId:t,batch:r[t]}:void 0}},store.checkBatchForPending=async function(t){t=await this.getFullMessageBatch(t);let e=!1;return t.messages.forEach(t=>{("pending"===t.status||t.status.startsWith("sending: ")&&t.statusUpdatedTimestamp+tenSeconds>getCurrentTimestamp())&&(e=!0)}),e},store.checkBatchForErrors=async function(t){t=await this.getFullMessageBatch(t);let e=!1;return t.messages.forEach(t=>{"error"===t.status&&(e=!0),t.status.startsWith("sending: ")&&t.statusUpdatedTimestamp+tenSeconds<=getCurrentTimestamp()&&(e=!0)}),e},store.getFullMessageBatch=async function(t){var e=await browser_polyfill.storage.local.get(t);if(e)return this.updateBatchSchema(t,e[t])},store.updateBatchSchema=async function(e,a){if(a){let t=!1;for(messageIndex in a.messages){var s=a.messages[messageIndex];if(void 0!==s.id&&s.phoneNumbers)break;s.phoneNumbers=[s.phoneNumber],s.id=messageIndex,t=!0}t&&await browser_polyfill.storage.local.set({[e]:a})}return a},store.getMessageBatchIndex=async function(){var t=await browser_polyfill.storage.local.get("batchIndex");return t&&t.batchIndex?t.batchIndex:{}},store.updateBatchStatus=async function(t,e){var a=await this.getMessageBatchIndex();a[t].status=e,a[t].statusUpdatedTimestamp=getCurrentTimestamp(),await browser_polyfill.storage.local.set({batchIndex:a})},store.recordMessageStatus=async function(t,e,a,s){var r=await this.getFullMessageBatch(t);return r.messages.forEach(t=>{t.id===e.id&&t.text===e.text&&(t.status=a,t.statusUpdatedTimestamp=getCurrentTimestamp(),s)&&(t.statusDetails=s)}),browser_polyfill.storage.local.set({[t]:r})},store.recordPageReload=async function(t,e){var a=await this.getFullMessageBatch(t);return a.messages.forEach(t=>{t.id===e.id&&t.text===e.text&&(t.pageReloadCount=(t.pageReloadCount||0)+1,t.statusUpdatedTimestamp=getCurrentTimestamp())}),browser_polyfill.storage.local.set({[t]:a})};

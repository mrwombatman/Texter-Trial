{if("undefined"!=typeof importScripts)try{importScripts("./lib/store.js")}catch(e){console.error(e)}let c;"undefined"!=typeof browser?c=browser:"undefined"!=typeof chrome&&(c=chrome);let p,t=!1,i={"Google Voice":{query:"https://voice.google.com/u/*",newTab:"https://voice.google.com/u/0/messages"},Android:{query:"https://messages.google.com/web/*",newTab:"https://messages.google.com/web/conversations"},TextNow:{query:"https://www.textnow.com/messaging*",newTab:"https://www.textnow.com/messaging"},Dialpad:{query:"https://dialpad.com/app*",newTab:"https://dialpad.com/app"},Zoom:{query:"https://app.zoom.us/wc/phone*",newTab:"https://app.zoom.us/wc/phone"}};const e=async()=>{c.scripting?(await c.scripting.getRegisteredContentScripts({ids:["app.bulktexterpro.com"]}))?.length||await c.scripting.registerContentScripts([{id:"app.bulktexterpro.com",js:["lib/store.js","contentScripts/api.js"],persistAcrossSessions:!0,matches:["https://app.bulktexterpro.com/*"],runAt:"document_start",allFrames:!1},{id:"app.zoom.us.active",matches:["https://app.zoom.us/*"],runAt:"document_start",world:"MAIN",js:["contentScripts/keepWindowActive.js"],allFrames:!0},{id:"app.zoom.us",js:["contentScripts/utilities.js","lib/store.js","contentScripts/sendQueue.js","contentScripts/platforms/zoom.js"],persistAcrossSessions:!0,matches:["https://app.zoom.us/*"],allFrames:!1}]):console.error("Register scripts requested, but scripting permission is not approved.")};e();try{c.storage.local.get("GoogleVoiceURL").then(e=>{e=e?.GoogleVoiceURL;e&&(i["Google Voice"].newTab=e)})}catch(e){console.error("Error restoring Google Voice URL:",e)}async function getUser(){return(await c.storage.sync.get("BulkTexterPro_User"))?.BulkTexterPro_User}async function startTextingTab(e,t){let s=!1;var o=i[e];if(o){var a=await c.tabs.query({url:o.query});if(0<a.length){a=a[0];try{var r=a.id,n=/^(https:\/\/voice\.google\.com\/u\/[0-9]+\/(?:messages|calls))/;if("Google Voice"===e&&a.url.match(n)){let[e]=a.url.match(n);e=e.replace("calls","messages"),i["Google Voice"].newTab=e,c.storage.local.set({GoogleVoiceURL:e})}"pending"===t&&await c.tabs.update(r,{active:!0}),await disableTabDiscarding(r),await c.tabs.sendMessage(r,{bulk_texter_pro:!0,eventType:"SEND_MESSAGES"}),s=!0}catch(e){await c.tabs.remove(a.id)}}s||await openTabAndAwaitLoaded(o.newTab)}}async function openTabAndAwaitLoaded(e){let s;var t=new Promise(e=>{s=e});let o=await c.tabs.create({active:!0,url:e}),a=(await disableTabDiscarding(o.id),c.tabs.onUpdated.addListener(r),setTimeout(async()=>{try{await c.tabs.remove(o.id)}catch(e){console.error("Error closing new tab. ",e)}c.tabs.onUpdated.removeListener(r),s(!1)},45e3));function r(e,t){e===o.id&&"complete"===t.status&&(clearTimeout(a),c.tabs.onUpdated.removeListener(r),s(o))}return t}async function disableTabDiscarding(e){try{await c.tabs.update(e,{autoDiscardable:!1})}catch(e){}}async function processPendingMessages(){if(t)return!1;t=!0;try{var e=await store.getPendingBatch();if(e){if(!(await getUser()).anyActiveSubscriptions)return!1;await startTextingTab(e?.batch?.metadata?.platform,e?.batch?.status)}}catch(e){console.error("Error during message processing: ",e,"\n",e.stack)}finally{t=!1}}async function chooseFromGooglePhotos(){passMessageToTab((await openTabAndAwaitLoaded("https://docs.google.com/picker?protocol=gadgets&multiselectEnabled=false&hostId=google-voice&hl=en-US&authuser=0&thumbs=1920X1920&parent=https://voice.google.com/favicon.ico&nav=((%22photos%22,%22Choose%20a%20photo%20from%20your%20Google%20Photos%20Library.%20You%20can%20upload%20new%20photos%20at%20https%3A%2F%2Fphotos.google.com%2F.%22,{%22allowedItemTypes%22:%22photo%22,%22type%22:%22highlights%22}))&amc=true")).id,"LET_USER_CHOOSE_PHOTO")}async function passMessageToTab(e,t,s){let o;var a=new Promise(e=>{o=e});return c.tabs.sendMessage(e,{bulk_texter_pro:!0,eventType:t,payload:s},e=>{o(e)}),a}processPendingMessages(),c.alarms.create("BulkTexterPro_check_pending_messages",{periodInMinutes:1}),c.alarms.onAlarm.addListener(e=>{"BulkTexterPro_check_pending_messages"===e.name&&processPendingMessages()}),c.runtime.onInstalled.addListener(function(e){"install"===e.reason&&(c.tabs.create({url:"/app/index.html"}),c.storage.sync.set({First_Version:c.runtime?.getManifest()?.version}))}),c.alarms.onAlarm.addListener(e=>{if(e.name.startsWith("BulkTexterPro_BACKUP_TIMEOUT|")){var[,e,t]=e.name.split("|");try{passMessageToTab(parseInt(e),"TIMEOUT_FINISHED",{timeoutId:t})}catch(e){console.error("Error with background timeout: ",e)}}}),c.runtime.onMessage.addListener(function(t,e,s){if(t.bulk_texter_pro)try{var o;if("SET_TIMEOUT"!==t.eventType)return"SEND_NOW"===t.eventType?(processPendingMessages(),s(!0)):"PROXY_TO_CONTENT_SCRIPTS"===t.eventType?(passMessageToTab(e.tab.id,t.payload.eventType,t.payload).then(e=>s(e)),!0):"CHOOSE_FROM_GOOGLE_PHOTOS"===t.eventType?(p=e.tab.id,chooseFromGooglePhotos(),s(!0)):"PHOTO_CHOSEN"!==t.eventType?"RELOAD_EXTENSION"===t.eventType?(c.runtime.reload(),s(!0)):"GET_PERMISSIONS"===t.eventType?(c.permissions.getAll().then(e=>s(e)),!0):"REQUEST_PERMISSIONS"===t.eventType?(c.permissions.request(t.payload.requested).then(e=>s(e)).catch(e=>{c.tabs.create({active:!0,url:"/app/index.html?permissions="+JSON.stringify(t.payload.requested)}),s(!0)}),!0):void 0:(o=e.tab.id,c.tabs.remove(o),passMessageToTab(p,"PROXY_PHOTO_CHOSEN",t.payload),void c.tabs.update(p,{active:!0}));{const n=e.tab.id,i=t?.payload?.timeoutId;var a,r=t?.payload?.timeoutDuration;void(3e4<=r?(a=r/1e3/60,c.alarms.create(`BulkTexterPro_BACKUP_TIMEOUT|${n}|`+i,{delayInMinutes:a})):setTimeout(()=>{try{passMessageToTab(n,"TIMEOUT_FINISHED",{timeoutId:i})}catch(e){console.error("Error with background timeout: ",e)}},r))}}catch(e){console.error("Error in background events: ",e)}})}

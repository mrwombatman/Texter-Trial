class SendQueue{constructor(){this.abortSend=!1,this.sendInterval=5e3,this.currentSendExecutionQueue=[],this.currentMessageSending,this.messagesToSend=[],this.sendInProgress=!1,this.currentBatchId="",this.registeredAccountEmails=[],this.accountVerified=!1,this.textingPlatform="",this.textingPlatformEmail="",this.progressReport={},this.originalTitle="",this.getSendExecutionQueue=null,this.verifyAccount=null,this.verifyNumberReady=null}initialize=async(e,t,s,i)=>{browser_polyfill.runtime.onMessage.addListener((e,t,s)=>{"SEND_MESSAGES"===e.eventType&&this.checkForMessages()}),this.textingPlatform=e,this.getSendExecutionQueue=t,this.verifyAccount=s,this.verifyNumberReady=i,this.originalTitle=window.document.title,this.injectBTPModal(),this.checkForMessages()};checkAccountVerification=async()=>{if(this.accountVerified)return!0;let t=await getUser();this.accountVerified=await keepTrying(async()=>{var e=await this.verifyAccount(t);return e?.textingPlatformEmail?(this.textingPlatformEmail=e.textingPlatformEmail,e.verified):e?.verified||e},!0)};checkForMessages=async()=>{if(!this.sendInProgress&&0===this.messagesToSend.length){this.sendInProgress=!0;var e=await store.getPendingBatch();if(e)if(e?.batch?.metadata?.platform!==this.textingPlatform)this.sendInProgress=!1;else{if(!await keepTrying(this.verifyNumberReady,!0))return this.showNumberReadyError(),await store.updateBatchStatus(e.batchId,"not ready"),this.sendInProgress=!1;if(await this.checkAccountVerification(),!this.accountVerified)return this.showVerifyError(),await store.updateBatchStatus(e.batchId,"unverified"),this.sendInProgress=!1;this.sendInterval=e.batch.sendInterval,this.currentBatchId=e.batchId,this.progressReport={pending:0,sent:0,failed:0},this.showBTPModal(),await store.updateBatchStatus(e.batchId,"sending");let t=await store.getFullMessageBatch(e.batchId);t.photoBase64&&t.messages.forEach(e=>{e.photoBase64=t.photoBase64}),this.addMessagesToQueue(t.messages,t.queue),this.sendFromQueue()}else this.sendInProgress=!1}};addMessagesToQueue(e){this.messagesToSend=this.messagesToSend.concat(e)}sendFromQueue=async()=>{let t=5,s=!1;if(!this.checkIfMessagesFinished()){if(this.updateProgressReport(),this.currentMessageSending=this.messagesToSend.shift(),"pending"!==this.currentMessageSending.status)return"sent"===this.currentMessageSending.status?this.updateProgressReport({addSent:!0}):this.updateProgressReport({addFailed:!0}),this.proceedToNextMessage(!1);let e;for(this.currentSendExecutionQueue=this.getSendExecutionQueue();this.currentSendExecutionQueue.length&&!this.abortSend;){this.updateTabTitle();var i=this.currentSendExecutionQueue.shift();store.recordMessageStatus(this.currentBatchId,this.currentMessageSending,"sending: "+getFunctionName(i));try{var r=0<t&&!s;e=await keepTrying(i,r)}catch(e){return console.error(e),2<=this.currentMessageSending.pageReloadCount||s?await store.recordMessageStatus(this.currentBatchId,this.currentMessageSending,"sending: "+getFunctionName(i),e.message):(await store.recordPageReload(this.currentBatchId,this.currentMessageSending),await store.recordMessageStatus(this.currentBatchId,this.currentMessageSending,"pending","Reloading page and trying again – please ensure your computer is unlocked and the tab that Bulk Texter Pro is using is visible. Error: "+e.message)),window.location.reload()}if(!e){if(console.log(`BulkTexterPro - Step failed (${getFunctionName(i)}).`),t--,s)return this.updateProgressReport({addFailed:!0}),this.proceedToNextMessage(!0);console.log("BulkTexterPro - retrying full message send"),this.currentSendExecutionQueue=this.getSendExecutionQueue(),await new Promise(e=>setBackgroundTimeout(e,2e3))}"sendMessage"!==getFunctionName(i)&&"sendPhoto"!==getFunctionName(i)||(s=!0)}e&&(store.recordMessageStatus(this.currentBatchId,this.currentMessageSending,"sent"),this.updateProgressReport({addSent:!0}),this.proceedToNextMessage(!0))}};proceedToNextMessage(e){this.checkIfMessagesFinished()||(e?setBackgroundTimeout(this.sendFromQueue,this.sendInterval):setBackgroundTimeout(this.sendFromQueue,0))}checkIfMessagesFinished=()=>{if(0===this.messagesToSend.length)return this.updateTabTitle(),this.sendInProgress=!1,setBackgroundTimeout(this.hideBTPModal,3e3),setBackgroundTimeout(this.checkForMessages,5e3),!0};updateTabTitle=()=>{0<this.progressReport.pending?window.document.title=`BTP: ${this.progressReport.pending} pending text${1===this.progressReport.pending?"":"s"} – `+this.originalTitle:window.document.title=this.originalTitle};getBTPModal=()=>document?.getElementById("btp-shadow-root")?.shadowRoot;injectBTPModal=()=>{this.getBTPModal()?.querySelector("#btp-modal-overlay")||fetch(browser_polyfill.runtime.getURL("/contentScripts/injectedModal.html")).then(e=>e.text()).then(e=>{var t=document.createElement("div"),e=(t.innerHTML=e,document.body.insertAdjacentHTML("beforeend",'<div id="btp-shadow-root"></div>'),document.getElementById("btp-shadow-root").attachShadow({mode:"open"}));e.appendChild(t),e.getElementById("btp-cancel-button").onclick=this.cancelCurrentMessages,e.getElementById("btp-close-not-ready-button").onclick=this.hideBTPModal,e.getElementById("btp-close-unverified-button").onclick=this.hideBTPModal})};updateProgressReport=e=>{this.progressReport.pending=this.messagesToSend.length,e?.addFailed&&this.progressReport.failed++,e?.addSent&&this.progressReport.sent++,this.updateTabTitle();const s=this.getBTPModal();s&&((e=(e,t)=>{e=s.getElementById(e);e.style.display=0<t?"block":"none",e.querySelector(".progress-number").innerText=999<t?"999+":t})("texts-pending",this.progressReport.pending),e("texts-sent",this.progressReport.sent),e("texts-failed",this.progressReport.failed));e=0<this.progressReport.failed;this.setDisplay("#failed-texts-guide",e?"block":"none")};setDisplay=(t,s)=>{keepTrying(()=>{var e=this.getBTPModal()?.querySelector(t);if(e)return e.style.display=s,!0},!0)};showBTPModal=()=>{this.setDisplay("#btp-modal-overlay","block"),this.setDisplay("#btp-sending-info","block"),this.setDisplay("#btp-verify-error","none"),this.setDisplay("#btp-number-ready-error","none")};hideBTPModal=()=>{this.setDisplay("#btp-modal-overlay","none")};updateTextingPlatformName=()=>{(this.getBTPModal()?.querySelectorAll(".texting-platform-name"))?.forEach(e=>e.innerText=this.textingPlatform)};showNumberReadyError=()=>{this.updateTextingPlatformName(),"Google Voice"===this.textingPlatform?this.setDisplay("#btp-number-ready-google-voice","block"):this.setDisplay("#btp-number-ready-google-voice","none"),this.setDisplay("#btp-number-ready-error","block"),this.setDisplay("#btp-sending-info","none"),this.setDisplay("#btp-modal-overlay","block")};showVerifyError=()=>{this.updateTextingPlatformName(),(this.getBTPModal()?.getElementById("texting-platform-email")).innerText=this.textingPlatformEmail||"(not found)",this.setDisplay("#btp-generic-verify-error","none"),this.setDisplay("#btp-account-email-verify-error","none"),this.setDisplay("#btp-google-voice-verify-error","none"),"Google Voice"===this.textingPlatform&&this.setDisplay("#btp-google-voice-verify-error","block"),["Google Voice","TextNow"].includes(this.textingPlatform)?this.setDisplay("#btp-account-email-verify-error","block"):this.setDisplay("#btp-generic-verify-error","block"),this.setDisplay("#btp-verify-error","block"),this.setDisplay("#btp-sending-info","none"),this.setDisplay("#btp-modal-overlay","block")};cancelCurrentMessages=async()=>{this.abortSend=!0,this.messagesToSend=[],this.currentMessageSending={},this.sendInProgress=!1,await store.updateBatchStatus(this.currentBatchId,"cancelled"),this.hideBTPModal(),location.reload()}}
